name: webvi-experiments ci

on:
  push:
    branches:
    - '*'

jobs:
  build:
    runs-on: windows-2019
    steps:
    - name: Checkout repository
      uses: actions/checkout@v1
    - name: Lint markdown
      run: |
        npm ci
        npm test
    # - name: Install LabVIEW NXG
    #   run: powershell .\BuildTools\install.ps1
    - name: Start capturing screenshots
      working-directory: ./BuildTools/periodic-screenshot
      run: |
        npm ci
        npm run start
    # - name: Build LabVIEW Projects
    #   run: powershell .\BuildTools\build.ps1 -usemonitor
    #   timeout-minutes: 60
    #   continue-on-error: true
    - name: Stop capturing screenshots
      working-directory: ./BuildTools/periodic-screenshot
      run: npm run stop
    - name: Upload screenshots
      uses: actions/upload-artifact@v2
      with:
        name: screenshots
        path: ./BuildTools/periodic-screenshot/dist
    - name: Create GitHub Pages Output
      run: powershell .\BuildTools\ghpages.ps1
    - name: Upload GitHub Pages Output
      uses: actions/upload-artifact@v2
      with:
        name: ghpagesarchive
        path: ./ghpagesarchive/ghpages.zip
  deploy:
    needs: build
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-18.04
    steps:
    - name: Setup ruby
      uses: actions/setup-ruby@v1
      with:
        ruby-version: '2.6'
    - name: Setup pages deploy
      run: gem install dpl
    - name: Download GitHub Pages Output
      uses: actions/download-artifact@v2
      with:
        name: ghpagesarchive
    - run: ls -R
    - name: Extract GitHub Pages Output
      run: unzip ./ghpages.zip -d ./ghpagesout
    - run: ls -R
    - name: Deploy to GitHub Pages
      run: dpl --verbose --provider=pages --repo=rajsite/webvi-experiments --local_dir=ghpagesout --skip_cleanup --name=rajsite --email=rajsite@users.noreply.github.com --github-token=${{ secrets.GHPAGES_TOKEN }}
